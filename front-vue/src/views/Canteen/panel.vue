<template>
  <div class="animate-fade-in mt-9 mb-9">
    <!-- Encabezado -->
    <div class="mb-8 text-center">
      <h1
        class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400"
      >
        Panell de Cantina
      </h1>
      <p class="text-gray-300 mt-2">
        Gesti√≥ de comandes i men√∫ del servei de cantina
      </p>
    </div>

    <!-- Tarjetas de Resumen -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <!-- Pedidos Nuevos -->
      <div
        class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-300">Comandes noves</h3>
            <p class="text-3xl font-bold mt-2">{{ orderStats.new || 0 }}</p>
            <p class="text-sm text-gray-400 mt-1">Pendents de preparar</p>
          </div>
          <div class="p-3 rounded-full bg-blue-500/20">
            <svg
              class="w-8 h-8 text-blue-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
              />
            </svg>
          </div>
        </div>
        <router-link
          to="/canteen/chat"
          class="mt-4 inline-flex items-center text-sm text-blue-400 hover:text-blue-300 transition-colors"
        >
          Atendre comandes
          <svg
            class="w-4 h-4 ml-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </router-link>
      </div>

      <!-- Pedidos en Preparaci√≥n -->
      <div
        class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-300">En preparaci√≥</h3>
            <p class="text-3xl font-bold mt-2">
              {{ orderStats.active - orderStats.new || 0 }}
            </p>
            <p class="text-sm text-gray-400 mt-1">Comandes en proc√©s</p>
          </div>
          <div class="p-3 rounded-full bg-yellow-500/20">
            <svg
              class="w-8 h-8 text-yellow-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
              />
            </svg>
          </div>
        </div>
        <router-link
          to="/canteen/chat"
          class="mt-4 inline-flex items-center text-sm text-yellow-400 hover:text-yellow-300 transition-colors"
        >
          Veure en preparaci√≥
          <svg
            class="w-4 h-4 ml-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </router-link>
      </div>

      <!-- Pedidos Listos -->
      <div
        class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-300">
              Llestes per recollir
            </h3>
            <p class="text-3xl font-bold mt-2">
              {{ orderStats.completed || 0 }}
            </p>
            <p class="text-sm text-gray-400 mt-1">Esperant recollida</p>
          </div>
          <div class="p-3 rounded-full bg-green-500/20">
            <svg
              class="w-8 h-8 text-green-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
        </div>
        <router-link
          to="/canteen/chat"
          class="mt-4 inline-flex items-center text-sm text-green-400 hover:text-green-300 transition-colors"
        >
          Veure llestes
          <svg
            class="w-4 h-4 ml-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </router-link>
      </div>

      <!-- Productos del Men√∫ -->
      <div
        class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-300">
              Productes disponibles
            </h3>
            <p class="text-3xl font-bold mt-2">
              {{ menuStats.available || 0 }}
            </p>
            <p class="text-sm text-gray-400 mt-1">
              De {{ menuStats.total || 0 }} en total
            </p>
          </div>
          <div class="p-3 rounded-full bg-purple-500/20">
            <svg
              class="w-8 h-8 text-purple-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              />
            </svg>
          </div>
        </div>
        <router-link
          to="/canteen/menu-admin"
          class="mt-4 inline-flex items-center text-sm text-purple-400 hover:text-purple-300 transition-colors"
        >
          Gestionar men√∫
          <svg
            class="w-4 h-4 ml-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </router-link>
      </div>
    </div>

    <!-- Secci√≥n de Pedidos Recientes -->
    <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 shadow-lg mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-300">Comandes recents</h2>
        <button
          @click="loadRecentOrders"
          class="text-sm text-blue-400 hover:text-blue-300 transition-colors"
        >
          Actualitzar
        </button>
      </div>

      <div v-if="isLoadingOrders" class="flex justify-center py-4">
        <div
          class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-400"
        ></div>
      </div>

      <div
        v-else-if="recentOrders.length === 0"
        class="text-center py-4 text-gray-400"
      >
        No hi ha comandes recents
      </div>

      <div v-else class="space-y-4">
        <!-- Lista de pedidos recientes -->
        <div
          v-for="(order, index) in recentOrders"
          :key="index"
          class="flex items-start p-3 hover:bg-slate-700/30 rounded-lg transition-colors"
        >
          <!-- Icono gen√©rico para todos los pedidos -->
          <div class="p-2 rounded-lg mr-3 bg-purple-500/10">
            <svg
              class="w-5 h-5 text-purple-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
              />
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-medium">Comanda de {{ order.userName }}</p>
            <p class="text-sm text-gray-400">{{ getOrderSummary(order) }}</p>
          </div>
          <span class="text-xs text-gray-500">{{
            formatTimeAgo(order.timestamp)
          }}</span>
        </div>
      </div>
    </div>

    <!-- Acciones R√°pidas -->
    <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-6 shadow-lg">
      <h2 class="text-xl font-semibold text-gray-300 mb-4">
        Gesti√≥ de la Cantina
      </h2>
      <p class="text-sm text-gray-400 mb-5">
        Accedeix r√†pidament a les eines de gesti√≥ de la cantina
      </p>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4">
        <router-link
          to="/canteen/menu-admin"
          class="flex items-center justify-center p-4 bg-blue-500/10 hover:bg-blue-500/20 rounded-lg transition-colors"
        >
          <svg
            class="w-5 h-5 mr-2 text-blue-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"
            />
          </svg>
          <span>Nou producte</span>
        </router-link>

        <router-link
          to="/canteen/chat"
          class="flex items-center justify-center p-4 bg-purple-500/10 hover:bg-purple-500/20 rounded-lg transition-colors"
        >
          <svg
            class="w-5 h-5 mr-2 text-purple-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
            />
          </svg>
          <span>Veure missatges</span>
        </router-link>

        <!-- <router-link
          to="/canteen"
          class="flex items-center justify-center p-4 bg-amber-500/10 hover:bg-amber-500/20 rounded-lg transition-colors"
        >
          <svg
            class="w-5 h-5 mr-2 text-amber-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            />
          </svg>
          <span>Historial Comandes</span>
        </router-link>

        <router-link
          to="/canteen"
          class="flex items-center justify-center p-4 bg-green-500/10 hover:bg-green-500/20 rounded-lg transition-colors"
        >
          <svg
            class="w-5 h-5 mr-2 text-green-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <span>Horaris Cantina</span>
        </router-link> -->
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from "vue";
import { useAppStore } from "@/stores";
import { getAllCanteenItems } from "@/services/communicationsScripts/canteenComManager";
import chatManager from "@/services/communicationsScripts/chatsComManager";
import { getAllUsers } from "@/services/communicationsScripts/mainManager";

// Definir variables reactivas para almacenar las estad√≠sticas
const orderStats = ref({
  active: 0,
  new: 0,
  completed: 0,
  completedToday: 0,
});

const menuStats = ref({
  total: 0,
  available: 0,
});

const messageStats = ref({
  total: 0,
  unread: 0,
});

const popularStats = ref({
  name: "",
  orders: 0,
});

// Variables para pedidos recientes
const recentOrders = ref([]);
const isLoadingOrders = ref(false);

// Variable para el intervalo de actualizaci√≥n
let statsRefreshInterval = null;

// Tienda Vuex
const store = useAppStore();

// Cargar estad√≠sticas
const loadStats = async () => {
  try {
    // Cargar men√∫ para obtener estad√≠sticas
    const menuItems = await getAllCanteenItems();
    menuStats.value = {
      total: menuItems.length,
      available: menuItems.filter((item) => item.product_enabled).length,
    };

    // Obtener chats con informaci√≥n de pedidos
    const chats = await chatManager.getAllChats();

    // Identificar chats que pertenecen a la cantina
    const canteenChats = chats.filter(
      (chat) =>
        chat.teachers &&
        chat.interaction &&
        chat.interaction.length > 0 &&
        chat.teachers.includes(parseInt(store.getUserId()))
    );

    // Cargar el estado de mensajes no le√≠dos
    const unreadKey = `cantina_unread_messages_${store.getUserId()}`;
    let unreadMessages = {};
    try {
      const savedUnread = localStorage.getItem(unreadKey);
      if (savedUnread) {
        unreadMessages = JSON.parse(savedUnread);
      }
    } catch (e) {
      console.error("Error loading unread messages:", e);
    }

    // Filtrar chats que contienen pedidos (mensajes con formato de pedido)
    const orderChats = canteenChats.filter((chat) => {
      // Verificar si alg√∫n mensaje tiene formato de pedido
      return chat.interaction.some(
        (msg) =>
          msg.message.includes("üõí") ||
          msg.message.includes("Pedido") ||
          msg.message.includes("Total:") ||
          msg.message.includes("‚Ç¨")
      );
    });

    // Clasificar los pedidos seg√∫n el contenido de los mensajes en cada chat
    const newOrders = []; // Chats con mensajes nuevos no le√≠dos o sin respuesta
    const preparingOrders = []; // Chats con mensaje "‚úÖ Comanda rebuda"
    const readyOrders = []; // Chats con mensaje "üöö La teva comanda est√† llesta per a recollir"

    orderChats.forEach((chat) => {
      // Verificar si el chat tiene mensajes no le√≠dos
      if (unreadMessages[chat._id]) {
        newOrders.push(chat);
        return; // Si es nuevo, no seguimos analizando
      }

      // Si no hay mensajes no le√≠dos, verificamos el √∫ltimo estado seg√∫n los mensajes
      const messages = chat.interaction || [];

      // Flag para saber si ya se clasific√≥ el chat
      let chatClassified = false;

      // Recorrer los mensajes en orden inverso para encontrar el m√°s reciente
      for (let i = messages.length - 1; i >= 0; i--) {
        const msg = messages[i];

        // Verificar si es un mensaje de la cantina (del usuario actual)
        if (parseInt(msg.teacherId) === parseInt(store.getUserId())) {
          if (
            msg.message.includes(
              "üöö La teva comanda est√† llesta per a recollir"
            )
          ) {
            readyOrders.push(chat);
            chatClassified = true;
            break;
          } else if (msg.message.includes("‚úÖ Comanda rebuda")) {
            preparingOrders.push(chat);
            chatClassified = true;
            break;
          }
        }
      }

      // Si el chat no se ha clasificado y tiene al menos un mensaje, considerarlo nuevo
      if (!chatClassified && messages.length > 0) {
        // Verificar si el √∫ltimo mensaje es del cliente (no de la cantina)
        const lastMsg = messages[messages.length - 1];
        if (parseInt(lastMsg.teacherId) !== parseInt(store.getUserId())) {
          newOrders.push(chat);
        }
      }
    });

    // Actualizar estad√≠sticas de pedidos con datos reales
    orderStats.value = {
      active: newOrders.length + preparingOrders.length,
      new: newOrders.length,
      completed: readyOrders.length,
      completedToday: readyOrders.filter((chat) => {
        // Verificar si el pedido se complet√≥ hoy
        const lastMessage = chat.interaction[chat.interaction.length - 1];
        if (!lastMessage || !lastMessage.date) return false;

        const messageDate = new Date(lastMessage.date);
        const today = new Date();
        return (
          messageDate.getDate() === today.getDate() &&
          messageDate.getMonth() === today.getMonth() &&
          messageDate.getFullYear() === today.getFullYear()
        );
      }).length,
    };

    // Actualizar estad√≠sticas de mensajes con datos reales
    let totalMessages = 0;
    let unreadMessagesCount = 0;

    canteenChats.forEach((chat) => {
      if (chat.interaction) {
        totalMessages += chat.interaction.length;

        // Contar chats con mensajes no le√≠dos seg√∫n localStorage
        if (unreadMessages[chat._id]) {
          unreadMessagesCount++;
        }
      }
    });

    messageStats.value = {
      total: totalMessages,
      unread: unreadMessagesCount,
    };

    // Cargar pedidos recientes
    await loadRecentOrders();
  } catch (error) {
    console.error("Error loading stats:", error);
  }
};

// Funci√≥n para cargar pedidos recientes
const loadRecentOrders = async () => {
  isLoadingOrders.value = true;
  try {
    // Obtener todos los chats de la cantina
    const chats = await chatManager.getAllChats();

    // Filtrar chats con pedidos relevantes para la cantina
    const orderChats = chats.filter(
      (chat) =>
        chat.interaction &&
        chat.interaction.length > 0 &&
        chat.teachers &&
        chat.teachers.includes(parseInt(store.getUserId())) &&
        // Verificar si alg√∫n mensaje tiene formato de pedido
        chat.interaction.some(
          (msg) =>
            msg.message.includes("üõí") ||
            msg.message.includes("Pedido") ||
            msg.message.includes("Total:") ||
            (msg.message.includes("Pedido") && msg.message.includes("‚Ç¨"))
        )
    );

    // Obtener todos los usuarios para mostrar nombres correctos
    const allUsers = await getAllUsers();
    const userMap = {};
    allUsers.forEach((user) => {
      userMap[user.id] = user.name || user.username || `Usuario ${user.id}`;
    });

    // Cargar el estado de mensajes no le√≠dos
    const unreadKey = `cantina_unread_messages_${store.getUserId()}`;
    let unreadMessages = {};
    try {
      const savedUnread = localStorage.getItem(unreadKey);
      if (savedUnread) {
        unreadMessages = JSON.parse(savedUnread);
      }
    } catch (e) {
      console.error("Error loading unread messages:", e);
    }

    // Array para almacenar TODOS los mensajes de pedido de TODOS los chats
    const allOrderMessages = [];

    // Para cada chat, extraer TODOS los mensajes que son pedidos
    orderChats.forEach((chat) => {
      // Obtener el usuario del chat
      const otherUserId = chat.teachers.find(
        (id) => id !== parseInt(store.getUserId())
      );
      const userName = userMap[otherUserId] || `Usuario ${otherUserId}`;

      // Extraer todos los mensajes que tienen formato de pedido
      const orderMessages = chat.interaction.filter(
        (msg) =>
          msg.message.includes("üõí") ||
          msg.message.includes("Pedido") ||
          msg.message.includes("Total:") ||
          (msg.message.includes("Pedido") && msg.message.includes("‚Ç¨"))
      );

      // Determinar el estado del pedido seg√∫n los mensajes
      let status = "new";

      // Si tiene mensajes no le√≠dos, es nuevo
      if (unreadMessages[chat._id]) {
        status = "new";
      } else {
        // Recorrer los mensajes en orden inverso para encontrar el m√°s reciente estado
        const messages = chat.interaction || [];
        for (let i = messages.length - 1; i >= 0; i--) {
          const msg = messages[i];

          // Verificar si es un mensaje de la cantina
          if (parseInt(msg.teacherId) === parseInt(store.getUserId())) {
            if (
              msg.message.includes(
                "üöö La teva comanda est√† llesta per a recollir"
              )
            ) {
              status = "ready";
              break;
            } else if (msg.message.includes("‚úÖ Comanda rebuda")) {
              status = "preparing";
              break;
            }
          }
        }
      }

      // Para cada mensaje de pedido, crear un objeto de pedido y agregarlo a la lista
      orderMessages.forEach((msg) => {
        // Solo procesar mensajes que NO son del usuario cantina (solo pedidos de clientes)
        if (parseInt(msg.teacherId) !== parseInt(store.getUserId())) {
          allOrderMessages.push({
            id: chat._id,
            messageId: msg._id,
            userName: userName,
            status: status,
            items: extractOrderItems(msg.message),
            timestamp: new Date(msg.date),
            total: extractTotal(msg.message),
            message: msg.message,
            date: msg.date,
          });
        }
      });
    });


    // Ordenar por fecha (m√°s reciente primero) y tomar los 5 m√°s recientes
    recentOrders.value = allOrderMessages
      .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
      .slice(0, 5);

  } catch (error) {
    console.error("Error al cargar pedidos recientes:", error);
    recentOrders.value = [];
  } finally {
    isLoadingOrders.value = false;
  }
};

// Funci√≥n para simular exportaci√≥n de datos
const exportOrderData = () => {
  alert("Funci√≥n de exportaci√≥n de informes en desarrollo");
};

// Funci√≥n para mostrar el historial de pedidos
const showOrderHistory = () => {
  alert("Historial de pedidos en desarrollo");
};

// Funci√≥n para ver los productos populares
const viewPopularItems = () => {
  alert("Vista de productos populares en desarrollo");
};

// Funci√≥n para actualizar las estad√≠sticas
const refreshStats = () => {
  loadStats();
};

// Extraer resumen de pedido
const getOrderSummary = (order) => {
  if (order.items && order.items.length > 0) {
    const displayItems = order.items.slice(0, 2);
    const remaining = order.items.length - 2;
    const summary = displayItems.join(", ");
    return `${summary}${remaining > 0 ? ` y ${remaining} m√°s` : ""} - Total: ${
      order.total || "?"
    }‚Ç¨`;
  }
  return "Pedido sin detalles";
};

// Extraer √≠tems de un mensaje de pedido
const extractOrderItems = (message) => {
  // Esta es una funci√≥n simulada - en realidad necesitar√≠a una l√≥gica m√°s robusta
  // para extraer los √≠tems de un mensaje con formato de pedido
  const items = [];
  const lines = message.split("\n");

  for (const line of lines) {
    if (line.includes("‚Ä¢") || line.includes("-")) {
      const item = line.replace(/‚Ä¢|-/g, "").trim();
      if (item && !item.includes("Total:")) {
        items.push(item.split(" - ")[0]);
      }
    }
  }

  return items.length > 0 ? items : ["Producto no especificado"];
};

// Extraer el total de un mensaje de pedido
const extractTotal = (message) => {
  if (!message) return "?";

  // Buscar un patr√≥n de precio total
  const totalMatch = message.match(/Total:\s*(\d+[\.,]\d+)/);
  if (totalMatch && totalMatch[1]) {
    return totalMatch[1].replace(",", ".");
  }

  // Intentar encontrar cualquier valor con formato de precio
  const priceMatch = message.match(/(\d+[\.,]\d+)\s*‚Ç¨/);
  return priceMatch && priceMatch[1] ? priceMatch[1].replace(",", ".") : "?";
};

// Formatear tiempo transcurrido
const formatTimeAgo = (dateString) => {
  try {
    if (!dateString) return "Fecha desconocida";

    const now = new Date();
    const date = new Date(dateString);

    // Verificar que la fecha sea v√°lida
    if (isNaN(date.getTime())) return "Fecha inv√°lida";

    const diffMs = now - date;
    if (diffMs < 0) return "Fecha futura";

    const diffMins = Math.round(diffMs / 60000);

    if (diffMins < 1) return "Justo ahora";
    if (diffMins < 60) return `Hace ${diffMins} min`;

    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24)
      return `Hace ${diffHours} hora${diffHours > 1 ? "s" : ""}`;

    const diffDays = Math.floor(diffHours / 24);
    return `Hace ${diffDays} d√≠a${diffDays > 1 ? "s" : ""}`;
  } catch (error) {
    console.error("Error al formatear fecha:", error);
    return "Fecha desconocida";
  }
};

// Obtener clase seg√∫n estado del pedido
const getOrderStatusClass = (status) => {
  switch (status) {
    case "new":
      return {
        bgColor: "bg-blue-500/10",
        textColor: "text-blue-400",
        icon: "M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z",
      };
    case "preparing":
      return {
        bgColor: "bg-yellow-500/10",
        textColor: "text-yellow-400",
        icon: "M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9",
      };
    case "ready":
      return {
        bgColor: "bg-green-500/10",
        textColor: "text-green-400",
        icon: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
      };
    case "completed":
      return {
        bgColor: "bg-purple-500/10",
        textColor: "text-purple-400",
        icon: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
      };
    default:
      return {
        bgColor: "bg-gray-500/10",
        textColor: "text-gray-400",
        icon: "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
      };
  }
};

// Cargar los datos cuando el componente se monte
onMounted(() => {
  loadStats();

  // Configurar un intervalo para actualizar las estad√≠sticas peri√≥dicamente
  statsRefreshInterval = setInterval(() => {
    loadStats();
  }, 30000); // Actualizar cada 30 segundos
});

// Limpiar el intervalo cuando se desmonte el componente
onUnmounted(() => {
  if (statsRefreshInterval) {
    clearInterval(statsRefreshInterval);
    statsRefreshInterval = null;
  }
});
</script>

<style scoped>
.animate-fade-in {
  animation: fadeIn 0.8s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
